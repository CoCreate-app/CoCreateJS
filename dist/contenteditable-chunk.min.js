(this.webpackChunkCoCreate=this.webpackChunkCoCreate||[]).push([[754],{7895:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>c});var i=n(366),o=n(4752),s=n(439),a=n(8858),r=n(5611),l=n.n(r);var d=new class{constructor(){this._elements=[],this._init(),this.from=0,this.to=0}_init(t){let e=t||document;if(e.querySelector){var n=e.querySelectorAll("[contentEditable]:not([contentEditable='false'])");for(var o of(0==n.length&&e!=document&&e.hasAttribute("contentEditable")&&(n=[e]),n))i.default.getInitialized(o)||(i.default.setInitialized(o),this._initElement(o),this._elements.push(o))}}_initElement(t){if(t.matches("[contentEditable]:not([contentEditable='false'])"))if(this._initElementEvents(t),a.default&&a.default.checkID(t))t.innerHTML="",this._createYDoc(t);else{let e=this;t.addEventListener("set-document_id",(function(t){e._createYDoc(this)}))}}_initElementEvents(t){var e=this;t.addEventListener("select",(function(t){})),t.addEventListener("input",(function(t){let n=e.getSelectionInfo(this),i=n.start,o=i+1,s="",a=!0;switch(t.inputType){case"deleteContentBackward":i--,o--;break;case"deleteContentForward":break;case"insertLineBreak":s="\n",o++;break;case"insertText":s=t.data||"";break;case"deleteByCut":o=i;break;default:a=!1}a&&(n.is_selected?(e.sendChangeData(this,"",n.start,n.end),s.length>0&&e.sendChangeData(this,s,i,o),e.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)):e.sendChangeData(this,s,i,o))})),t.addEventListener("paste",(function(t){let n=event.clipboardData.getData("Text"),i=e.getSelectionInfo(this);i.start!==i.end&&e.sendChangeData(this,"",i.start,i.end,!1),e.sendChangeData(this,n,i.start,i.end,!1),event.preventDefault()})),t.addEventListener("keyup",(function(t){-1!=[37,38,39,40].indexOf(t.keyCode)&&e.sendPosition(this)})),t.addEventListener("keydown",(function(n){-1!=[37,38,39,40].indexOf(n.keyCode)&&e.sendPosition(this);const i=e._getCaretPosition(t);e.setSelectionInfo(t,i.from!=i.to,i.from,i.to)})),t.addEventListener("click",(function(t){e.sendPosition(this)})),t.addEventListener("blur",(function(n){e.sendPosition(t,!0)})),t.addEventListener("cocreate-crdt-update",(function(t){var n=event.detail,i=0,o=!0;n.forEach((t=>{t.retain&&(o=!0,i=t.retain),(t.insert||t.delete)&&(0==o&&(i=0),o=!1,t.insert?e.insertData(this,t.insert,i):t.delete&&e.deleteData(this,i,i+t.delete))}))}))}sendChangeData(t,e,n,i,r=!0){if(!this._checkConetentEditable(t))return;const{collection:d,document_id:c,name:h}=l().getAttr(t);if(!c)return a.default.request({element:t,nameAttr:"name"}),void t.setAttribute("data-document_id","pending");if("pending"===c)return;if(!l().isSaveAttr(t))return;e.length>0?(r&&this.deleteData(t,n,n+e.length),o.default.insertText({collection:d,document_id:c,name:h,value:e,position:n,attributes:null})):(r&&this.insertData(t," ".repeat(i-n),n),o.default.deleteText({collection:d,document_id:c,name:h,position:n,length:i-n}));let u=e.length>0?e.length:-1;s.default.recalculate_local_cursors(t,u)}setSelectionInfo(t,e,n,i){t.setAttribute("is_selected",e),t.setAttribute("selection_start",n),t.setAttribute("selection_end",i),this.sendPosition(t)}getSelectionInfo(t){return{is_selected:"true"===t.getAttribute("is_selected"),start:parseInt(t.getAttribute("selection_start")),end:parseInt(t.getAttribute("selection_end"))}}sendPosition(t,e){if(this._checkConetentEditable(t)){var n=this._getCaretPosition(t),i=this._getElementInfo(t);if(n&&!e){i.startPosition=n.from,i.endPositon=n.to;const e=this._generateElementID(t);o.default.setPositionYJS(e,i.startPosition,i.endPositon)}else{var s=this._generateElementID(t);o.default.setCursorNull(s)}}}_getElementInfo(t){const{collection:e,document_id:n,name:i}=l().getAttr(t);return{collection:e||"_",document_id:n||"_",name:i||"_"}}_createYDoc(t){const{collection:e,document_id:n,name:i}=l().getAttr(t);o.default.init({collection:e,document_id:n,name:i,element:t})}_generateElementID(t){var e=this._getElementInfo(t);return o.default.generateID(config.organization_Id,e.collection,e.document_id,e.name)}_checkConetentEditable(t){if(!t.isContentEditable)return!1;for(var e of this._elements)if(t.isSameNode(e))return!0;return this._initElement(t),this._elements.push(t),!0}_getCaretPosition(t){if(document.activeElement!==t)return null;var e=document.getSelection();if(!e.rangeCount)return null;var n=e.getRangeAt(0),i=n.toString().length,o=n.cloneRange();o.selectNodeContents(t),o.setEnd(n.endContainer,n.endOffset);var s=o.toString().length;return{from:i?s-i:s,to:s}}_setCaretPosition(t,e,n){if(document.activeElement===t){var i=document.getSelection(),o=this._cloneRangeByPosition(t,e,n);i.removeAllRanges(),i.addRange(o)}}_cloneRangeByPosition(t,e,n,i){if(i||((i=document.createRange()).selectNode(t),i.setStart(t,0),this.from=e,this.to=n),t&&(this.from>0||this.to>0))if(t.nodeType===Node.TEXT_NODE)t.textContent.length<this.from?this.from-=t.textContent.length:this.from>0&&(i.setStart(t,this.from),this.from=0),t.textContent.length<this.to?this.to-=t.textContent.length:this.to>0&&(i.setEnd(t,this.to),this.to=0);else for(var o=0;o<t.childNodes.length&&(i=this._cloneRangeByPosition(t.childNodes[o],this.from,this.to,i),0!==this.from||0!==this.to);o++);return i}_getPositionFromRange(t,e){var n=document.createRange();n.selectNodeContents(t);var i;return n.setEnd(e.endContainer,e.endOffset),i=n.toString().length,n.setEnd(e.startContainer,e.startOffset),{from:n.toString().length,to:i}}insertData(t,e,n){if(e&&""!==e){var i,o=window.getSelection(),s=this._getCaretPosition(t),a=this._cloneRangeByPosition(t,n,n),r=document.createElement("div"),l=document.createDocumentFragment();for(r.innerHTML=e;i=r.firstChild;)l.appendChild(i);if(a.insertNode(l),!s)return o.addRange(a),void o.removeRange(a);var d=this.selectionProcessing(e,s.from,s.to,n,n);this._setCaretPosition(t,d.start,d.end),this.sendPosition(t)}}deleteData(t,e,n){if(n-e){var i=this._getCaretPosition(t),o=window.getSelection(),s=this._cloneRangeByPosition(t,e,n);if(s&&s.deleteContents(),i){var a=this.selectionProcessing("",i.from,i.to,e,n);this._setCaretPosition(t,a.start,a.end),this.sendPosition(t)}else o.removeRange(s)}}selectionProcessing(t,e,n,i,o){return e>=i&&(""==t?(n-=o-i,e=(e-=o-i)<i?i:e):(e+=t.length,n+=t.length)),""==t&&n>=i&&(n=n>=o?n-(o-i):i),{start:e,end:n}}};i.default.init({name:"CoCreateContentEditableInit",observe:["subtree","childList"],include:"[contenteditable][data-collection][data-document_id][name]",callback:function(t){d._init(t.target)}});const c=d}}]);
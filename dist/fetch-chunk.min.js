(this.webpackChunkCoCreate=this.webpackChunkCoCreate||[]).push([[3238],{4496:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>u});var i=a(366),l=a(3232),n=a(4727),r=a(5611),d=a.n(r),c=a(9844),o=a(1737);const s={selector:"[data-template_id][data-fetch_collection]",items:[],init:function(){this.initElement(),this.__initSocketEvent(),this.__initEvents()},initElement:function(t){let e=t||document;const a=this;if(!e.querySelectorAll)return;let i=e.querySelectorAll(this.selector);0==i.length&&e!=document&&e.hasAttribute("data-template_id")&&e.hasAttribute("data-fetch_collection")&&(i=[e]),i.forEach((t=>{a.__initEachElement(t,!0,!0)}))},refershElement:function(t){const{target:e}=t;e&&e.hasAttribute("data-fetch_collection")&&this.__initEachElement(e,!1,!1,!0)},reload:function(t){},__initSocketEvent:function(){const t=this;d().listen("readDocumentList",(function(e){t.__fetchedItem(e)})),d().listen("readCollectionList",(function(e){t.__fetchedItem(e)})),d().listen("createDocument",(function(e){t.__createItem(e)})),d().listen("deleteDocument",(function(e){t.__deleteItem(e)}))},__initEvents:function(){const t=this;window.addEventListener("dndsuccess",(function(e){const{dropedEl:a,dragedEl:i}=e.detail;let l=i.getAttribute("data-template_id"),n=document.querySelector(`[data-fetch_collection][data-template_id='${l}']`),r=t.findTemplateElByChild(a);n&&r&&(n.isSameNode(r)||(t.updateParentTemplateOfChild(r,i),t.reorderChildrenOfTemplate(n)),t.reorderChildrenOfTemplate(r))}))},__initEachElement:function(t,e,a,n){let r=t.getAttribute("data-template_id");if(!r)return;if(!t.getAttribute("data-fetch_collection"))return;if(i.default.getInitialized(t,"fetch")&&e)return;let d=l.default.getObjectByFilterId(this.items,r),c=null;const o=this;if(!e||!d){if(i.default.setInitialized(t,"fetch"),d)c=d.filter,l.default.changeCollection(c),n&&(d.filter.isRefresh=!0,o.__removeOldData(t),c.isRefresh=!0,c.startIndex=0);else{c=l.default.setFilter(t,"data-template_id","template");let e=t.getAttribute("data-fetch_value_type")||"string";if(!c)return;"collection"===e&&(c.is_collection=!0),d={el:t,filter:c,templateId:r,fetch_type:e},this.items.push(d),t.addEventListener("changeFilterInput",(function(t){o.__removeOldData(d.el),d.filter.startIndex=0,d.filter.isRefresh=!0,l.default.fetchData(d.filter)}))}l.default.fetchData(c)}},__runLoadMore:function(t){if(!t)return;let e=l.default.getObjectByFilterId(this.items,t);e&&e.filter.count>0&&l.default.fetchData(e.filter)},__removeOldData:function(t){let e=t.getAttribute("data-template_id");t.querySelectorAll("[templateId='"+e+"']").forEach((t=>t.remove()))},__cloneElement:function(t,e,a,i){let l=document.createElement(t.parentNode.tagName||"div"),n=t.cloneNode(!0);return n.setAttribute("templateId",e),a||(a="data"),n.getAttribute("data-render_array")||n.setAttribute("data-render_array",a),!n.getAttribute("data-render_key")&&i&&n.setAttribute("data-render_key",i),l.appendChild(n.cloneNode(!0)),l},__renderData:function(t,e,a="data"){let i=t.getAttribute("data-template_id"),l=t.querySelector(`.template[data-template_id='${i}'`);if(!l)return;let n=t.getAttribute("data-render_id"),r=t.getAttribute("data-pass_to"),d=n?{[n]:e}:e;a=a||"data",a=n?`${n}.${a}`:a;let s=this.__cloneElement(l,i,a,n);o.default.data({elements:s.children,data:d,passTo:r});let u=s.querySelector(`.template[data-template_id="${i}"]`);if(!u)return;u.remove(),l.insertAdjacentHTML("beforebegin",s.innerHTML);var f=new CustomEvent("fetchedTemplate",{bubbles:!0});t.dispatchEvent(f);let m=t.parentNode.getElementsByTagName("form");for(let t=0;t<m.length;t++){let e=m[t],a=e.querySelector(".passValueBtn");a&&c.default.__registerValuePassBtnEvent(e,a)}},__deleteItem:function(t){let e=t.collection,a=t.document_id;for(let t=0;t<this.items.length;t++){let n=this.items[t];if(n.filter.collection==e){var i=n.el.getAttribute("data-template_id"),l=n.el.querySelectorAll("[templateId='"+i+"'][data-document_id='"+a+"']");for(let t=0;t<l.length;t++)l[t].remove(),n.startIndex--}}},__fetchedItem:function(t){let e=t.element,a=l.default.getObjectByFilterId(this.items,e);if(a){a.filter.startIndex+=t.data.length;let e=a.el.getAttribute("data-fetch_name");e&&(t=t.data[0]),t&&(t.metadata&&t.metadata.isRefresh&&this.__removeOldData(a.el),this.__renderData(a.el,t,e))}},__createItem:function(t){let e=t.collection;const a=this;let i=t.data,l=t;l.data=[i],this.items.forEach((t=>{const{filter:n}=t;t.fetch_ids=[],n.collection===e&&!t.el.getAttribute("data-fetch_name")&&a.__checkItemByFilters(i,n.filters)&&a.__renderData(t.el,l)}))},findTemplateElByChild:function(t){return n.default.getParentFromElement(t,null,["data-template_id","data-fetch_collection"])},updateParentTemplateOfChild:function(t,e){const a=t.getAttribute("data-filter_name"),i=t.getAttribute("data-filter_value"),l=t.getAttribute("data-filter_operator");a&&"$eq"==l&&d().updateDocument({collection:t.getAttribute("data-fetch_collection"),document_id:e.getAttribute("data-document_id"),data:{[a]:i},broadcast:!1})},reorderChildrenOfTemplate:function(t){const e=t.getAttribute("data-order_by"),a=t.getAttribute("data-template_id");if(!e||!a)return;const i=t.querySelectorAll(`[data-template_id="${a}"][data-document_id]:not(.template)`),l="asc"!==t.getAttribute("data-order_type")?-1:1;i.forEach(((a,i)=>{a.classList.contains("template")||d().updateDocument({collection:t.getAttribute("data-fetch_collection"),document_id:a.getAttribute("data-document_id"),data:{[e]:i*l},broadcast:!1})}))},__checkItemByFilters:function(t,e){let a=!0;return!(!t||!e)&&(!Array.isArray(t)&&(e.forEach((({name:e,operator:i,type:l,value:n})=>{const r=t[e];if(a)switch(i){case"$contain":Array.isArray(r)&&r.some((t=>n.includes(t)))||(a=!1);break;case"$range":null!==n[0]&&null!==n[1]?(n[0]>r||n[1]<=r)&&(a=!1):(null==t.value[0]&&n[1]>=r||null==t.value[1]&&n[0]<=r)&&(a=!1);break;case"$eq":r!=n[0]&&(a=!1);break;case"$ne":null!=r&&r!=n[0]||(a=!1);break;case"$lt":r>=n[0]&&(a=!1);break;case"$lte":r>n[0]&&(a=!1);break;case"$gt":r<=n[0]&&(a=!1);break;case"$gte":r<n[0]&&(a=!1);break;case"$in":Array.isArray(r)&&r.some((t=>n.includes(t)))||(a=!1);break;case"$nin":Array.isArray(r)&&r.some((t=>n.includes(t)))&&(a=!1)}})),a))}};i.default.init({name:"CoCreateFetchObserver",observe:["attributes"],attributesFilter:["data-fetch_collection","data-filter_name"],callback:function(t){s.refershElement(t)}}),i.default.init({name:"CoCreateFetchInit",observe:["addedNodes"],attributes:["data-fetch_collection"],callback:function(t){s.initElement(t.target)}}),s.init();const u=s}}]);
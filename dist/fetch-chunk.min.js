(this.webpackChunkCoCreate=this.webpackChunkCoCreate||[]).push([[3238],{4496:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>u});var l=a(366),i=a(3232),n=a(4727),r=a(5611),c=a.n(r),d=a(9844),o=a(1737);const s={selector:"[data-template_id][data-fetch_collection]",items:[],init:function(){this.initElement(),this.__initSocketEvent(),this.__initEvents()},initElement:function(t){let e=t||document;const a=this;if(!e.querySelectorAll)return;let l=e.querySelectorAll(this.selector);0==l.length&&e!=document&&e.hasAttribute("data-template_id")&&e.hasAttribute("data-fetch_collection")&&(l=[e]),l.forEach((t=>{a.__initEachElement(t,!0,!0)}))},refershElement:function(t){const{target:e}=t;e&&e.hasAttribute("data-fetch_collection")&&this.__initEachElement(e,!1,!1,!0)},reload:function(t){},__initSocketEvent:function(){const t=this;c().listen("readDocumentList",(function(e){t.__fetchedItem(e)})),c().listen("readCollectionList",(function(e){t.__fetchedItem(e)})),c().listen("createDocument",(function(e){t.__createItem(e)})),c().listen("deleteDocument",(function(e){t.__deleteItem(e)}))},__initEvents:function(){const t=this;window.addEventListener("dndsuccess",(function(e){const{dropedEl:a,dragedEl:l}=e.detail;let i=l.getAttribute("data-template_id"),n=document.querySelector(`[data-fetch_collection][data-template_id='${i}']`),r=t.findTemplateElByChild(a);n&&r&&(n.isSameNode(r)||(t.updateParentTemplateOfChild(r,l),t.reorderChildrenOfTemplate(n)),t.reorderChildrenOfTemplate(r))}))},__initEachElement:function(t,e,a,n){let r=t.getAttribute("data-template_id");if(!r)return;if(!t.getAttribute("data-fetch_collection"))return;if(l.default.getInitialized(t,"fetch")&&e)return;let c=i.default.getObjectByFilterId(this.items,r),d=null;const o=this;if(!e||!c){if(l.default.setInitialized(t,"fetch"),c)d=c.filter,i.default.changeCollection(d),n&&(c.filter.isRefresh=!0,o.__removeOldData(t),d.isRefresh=!0,d.startIndex=0);else{d=i.default.setFilter(t,"data-template_id","template");let e=t.getAttribute("data-fetch_value_type")||"string";if(!d)return;"collection"===e&&(d.is_collection=!0),c={el:t,filter:d,templateId:r,fetch_type:e},this.items.push(c),t.addEventListener("changeFilterInput",(function(t){o.__removeOldData(c.el),c.filter.startIndex=0,c.filter.isRefresh=!0,i.default.fetchData(c.filter)}))}i.default.fetchData(d)}},__runLoadMore:function(t){if(!t)return;let e=i.default.getObjectByFilterId(this.items,t);e&&e.filter.count>0&&i.default.fetchData(e.filter)},__removeOldData:function(t){let e=t.getAttribute("data-template_id");t.querySelectorAll("[templateId='"+e+"']").forEach((t=>t.remove()))},__cloneElement:function(t,e,a){let l=document.createElement(t.parentNode.tagName||"div"),i=t.cloneNode(!0);return i.setAttribute("templateId",e),a||(a="data"),i.getAttribute("data-render_array")||i.setAttribute("data-render_array",a),l.appendChild(i.cloneNode(!0)),l},__renderData:function(t,e,a="data"){let l=t.getAttribute("data-template_id"),i=t.querySelector(`.template[data-template_id='${l}'`);if(!i)return;let n=t.getAttribute("data-render_id"),r=t.getAttribute("data-pass_to"),c=n?{[n]:e}:e;a=a||"data",a=n?`${n}.${a}`:a;let s=this.__cloneElement(i,l,a);o.default.data({elements:s.children,data:c,passTo:r});let u=s.querySelector(`.template[data-template_id="${l}"]`);if(!u)return;u.remove(),i.insertAdjacentHTML("beforebegin",s.innerHTML);var f=new CustomEvent("fetchedTemplate",{bubbles:!0});t.dispatchEvent(f);let m=t.parentNode.getElementsByTagName("form");for(let t=0;t<m.length;t++){let e=m[t],a=e.querySelector(".passValueBtn");a&&d.default.__registerValuePassBtnEvent(e,a)}},__deleteItem:function(t){let e=t.collection,a=t.document_id;for(let t=0;t<this.items.length;t++){let n=this.items[t];if(n.filter.collection==e){var l=n.el.getAttribute("data-template_id"),i=n.el.querySelectorAll("[templateId='"+l+"'][data-document_id='"+a+"']");for(let t=0;t<i.length;t++)i[t].remove(),n.startIndex--}}},__fetchedItem:function(t){let e=t.element,a=i.default.getObjectByFilterId(this.items,e);if(a){a.filter.startIndex+=t.data.length;let e=a.el.getAttribute("data-fetch_name");e&&(t=t.data[0]),t&&(t.metadata&&t.metadata.isRefresh&&this.__removeOldData(a.el),this.__renderData(a.el,t,e))}},__createItem:function(t){let e=t.collection;const a=this;let l=t.data,i=t;i.data=[l],this.items.forEach((t=>{const{filter:n}=t;t.fetch_ids=[],n.collection===e&&!t.el.getAttribute("data-fetch_name")&&a.__checkItemByFilters(l,n.filters)&&a.__renderData(t.el,i)}))},findTemplateElByChild:function(t){return n.default.getParentFromElement(t,null,["data-template_id","data-fetch_collection"])},updateParentTemplateOfChild:function(t,e){const a=t.getAttribute("data-filter_name"),l=t.getAttribute("data-filter_value"),i=t.getAttribute("data-filter_operator");a&&"$eq"==i&&c().updateDocument({collection:t.getAttribute("data-fetch_collection"),document_id:e.getAttribute("data-document_id"),data:{[a]:l},broadcast:!1})},reorderChildrenOfTemplate:function(t){const e=t.getAttribute("data-order_by"),a=t.getAttribute("data-template_id");if(!e||!a)return;const l=t.querySelectorAll(`[data-template_id="${a}"][data-document_id]:not(.template)`),i="asc"!==t.getAttribute("data-order_type")?-1:1;l.forEach(((a,l)=>{a.classList.contains("template")||c().updateDocument({collection:t.getAttribute("data-fetch_collection"),document_id:a.getAttribute("data-document_id"),data:{[e]:l*i},broadcast:!1})}))},__checkItemByFilters:function(t,e){let a=!0;return!(!t||!e)&&(!Array.isArray(t)&&(e.forEach((({name:e,operator:l,type:i,value:n})=>{const r=t[e];if(a)switch(l){case"$contain":Array.isArray(r)&&r.some((t=>n.includes(t)))||(a=!1);break;case"$range":null!==n[0]&&null!==n[1]?(n[0]>r||n[1]<=r)&&(a=!1):(null==t.value[0]&&n[1]>=r||null==t.value[1]&&n[0]<=r)&&(a=!1);break;case"$eq":r!=n[0]&&(a=!1);break;case"$ne":null!=r&&r!=n[0]||(a=!1);break;case"$lt":r>=n[0]&&(a=!1);break;case"$lte":r>n[0]&&(a=!1);break;case"$gt":r<=n[0]&&(a=!1);break;case"$gte":r<n[0]&&(a=!1);break;case"$in":Array.isArray(r)&&r.some((t=>n.includes(t)))||(a=!1);break;case"$nin":Array.isArray(r)&&r.some((t=>n.includes(t)))&&(a=!1)}})),a))}};l.default.init({name:"CoCreateFetchObserver",observe:["attributes"],attributes:["data-fetch_collection","data-filter_name"],callback:function(t){s.refershElement(t)}}),l.default.init({name:"CoCreateFetchInit",observe:["subtree","childList"],include:"[data-fetch_collection]",callback:function(t){s.initElement(t.target)}}),s.init();const u=s}}]);
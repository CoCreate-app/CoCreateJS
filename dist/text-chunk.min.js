(this.webpackChunkCoCreate=this.webpackChunkCoCreate||[]).push([[924],{1384:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>d});n(8585);var i=n(5611),a=n.n(i),s=n(366),c=n(4752),o=n(439),l=n(8858);const r={elements:[],init:function(){this.initElement(document)},refreshElement:function(e){let t=e.target;if(!t)return;const n=t.tagName.toLowerCase();["input","textarea"].includes(n)&&t.getAttribute("data-document_id")&&t.getAttribute("name")&&a().isCRDT(t)&&(s.default.getInitialized(t,"text")||this.__initEvents(t),s.default.setInitialized(t,"text"),l.default.checkID(t)&&this.createYDoc(t,!0))},initElement:function(e){var t=this;let n=e||document,i=n.querySelectorAll("input[data-document_id][name], textarea[data-document_id][name]");0==i.length&&n!=document&&n.hasAttribute("data-document_id")&&n.hasAttribute("name")&&(i=[n]),i.forEach((e=>{a().isCRDT(e)&&(t.checkExistElement(e)||s.default.getInitialized(e,"text")||(s.default.setInitialized(e,"text"),t.__initEvents(e),l.default.checkID(e)?t.createYDoc(e):e.addEventListener("set-document_id",(function(e){let n=this,i=n.value;t.createYDoc(n),n.value="",t.sendChangeData(n,i,0,i.length)}))))}))},checkExistElement:function(e){for(var t=0;t<this.elements.length;t++)if(this.elements[t].isSameNode(e))return!0;return!1},setInitValue:function(e){var t=this.generateTypeName(e),n=c.default.getWholeString(t);e.value=n},createYDoc:function(e,t){const{collection:n,document_id:i,name:s}=a().getAttr(e);if(!a().checkValue(n)||!a().checkValue(i)||!a().checkValue(s))return;c.default.init({collection:n,document_id:i,name:s,element:e});t?e.value=c.default.getText({collection:n,document_id:i,name:s}):this.elements.push(e)},__initEvents:function(e){const t=this;e.addEventListener("select",(function(){this.selectionEnd!==this.selectionStart&&(t.setSelectionInfo(this,!0,this.selectionStart,this.selectionEnd),document.activeElement===this&&t.sendPosition(this))})),e.addEventListener("keyup",(function(e){-1!=[37,38,39,40].indexOf(e.keyCode)&&t.sendPosition(this)})),e.addEventListener("keydown",(function(e){-1!=[37,38,39,40].indexOf(e.keyCode)&&t.sendPosition(this)})),e.addEventListener("click",(function(e){document.activeElement===this&&t.sendPosition(this)})),e.addEventListener("blur",(function(e){const n=t.generateTypeName(this);c.default.setCursorNull(n)})),e.addEventListener("input",(function(e){let n=this.selectionStart-1,i=n,a=t.getSelectionInfo(this),s="",c=!1;switch(e.inputType){case"deleteContentBackward":case"deleteContentForward":c=!0,n++,i=n+1;break;case"insertLineBreak":c=!0,s="\n",i++;break;case"insertText":c=!0,s=e.data||"\n";break;case"deleteByCut":c=!0}if(c)if(a.is_selected){a.start,a.end;t.sendChangeData(this,"",a.start,a.end),s.length>0&&t.sendChangeData(this,s,n,i),t.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)}else t.sendChangeData(this,s,n,i)})),e.addEventListener("blur",(function(e){t.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)})),e.addEventListener("click",(function(e){t.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)})),e.addEventListener("paste",(function(e){let n=e.clipboardData.getData("Text"),i=this.selectionStart,a=this.selectionEnd;i!=a&&(this.setSelectionRange(a,a),t.sendChangeData(this,"",i,a,!1)),t.sendChangeData(this,n,i,i,!1),e.preventDefault()})),e.addEventListener("cocreate-crdt-update",(function(n){var i=n.detail;e.crudSetted=!0;var a=0,s=!0;i.forEach((e=>{e.retain&&(s=!0,a=e.retain),(e.insert||e.delete)&&(0==s&&(a=0),s=!1,e.insert?t.updateChangeData(this,e.insert,a,a):e.delete&&t.updateChangeData(this,"",a,a+e.delete))}))}))},setSelectionInfo:function(e,t,n,i){e.setAttribute("is_selected",t),e.setAttribute("selection_start",n),e.setAttribute("selection_end",i),this.sendPosition(e)},getSelectionInfo:function(e){return{is_selected:"true"===e.getAttribute("is_selected"),start:parseInt(e.getAttribute("selection_start")),end:parseInt(e.getAttribute("selection_end"))}},sendChangeData:function(e,t,n,i,s=!0){const{collection:r,document_id:d,name:u}=a().getAttr(e);if(!d||""===d)return l.default.request({element:e,nameAttr:"name"}),void e.setAttribute("data-document_id","pending");if("pending"==d)return;if(!a().isSaveAttr(e))return;let h=t.length>0?t.length:-1;o.default.recalculate_local_cursors(e,h),this.sendPosition(e),t.length>0?(s&&e.setRangeText("",n,n+t.length,"start"),c.default.insertText({collection:r,document_id:d,name:u,value:t,position:n})):(s&&e.setRangeText(" ".repeat(i-n),n,n,"end"),c.default.deleteText({collection:r,document_id:d,name:u,position:n,length:i-n})),document.activeElement===e&&(this.setSelectionInfo(e,!1,e.selectionStart,e.selectionStart),this.sendPosition(e))},updateChangeData:function(e,t,n,i){let a=e.selectionStart,s=e.selectionEnd;e.setRangeText(t,n,i,"end"),a>=n&&(""==t?(a-=i-n,s-=i-n,a=a<n?n:a):(a+=t.length,s+=t.length)),""==t&&s>=n&&(s=s>=i?s-(i-n):n),e.selectionStart=a,e.selectionEnd=s;document.activeElement;o.default.refresh_mirror(e)},generateTypeName:function(e){const{collection:t,document_id:n,name:i}=a().getAttr(e);return c.default.generateID(config.organization_Id,t,n,i)},setText:function(e,t){var n=0,i=!0;t.forEach((t=>{t.retain&&(i=!0,n=t.retain),(t.insert||t.delete)&&(0==i&&(n=0),i=!1,t.insert?this.receiveChangeData(e,t.insert,n,n):t.delete&&this.receiveChangeData(e,"",n,n+t.delete))}))},isAvaiableEl:function(e){for(var t=0;t<this.elements.length;t++)if(!0===this.elements[t].isEqualNode(e))return!0;return!1},sendPosition:function(e){const t=this.generateTypeName(e);let n=e.selectionStart,i=e.selectionEnd;c.default.setPositionYJS(t,n,i)}};r.init(),s.default.init({name:"CoCreateTextCreate",observe:["subtree","childList"],include:"[data-collection][data-document_id][name]",callback:function(e){r.initElement(e.target)}}),s.default.init({name:"CoCreateTextNameObserver",observe:["attributes"],attributes:["name"],callback:function(e){r.refreshElement(e)}});const d=r}}]);